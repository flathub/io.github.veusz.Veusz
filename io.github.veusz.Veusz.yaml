app-id: io.github.veusz.Veusz
runtime: org.kde.Platform
runtime-version: 5.15-21.08
sdk: org.kde.Sdk
command: veusz
separate-locales: false
finish-args:
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  - --device=dri

cleanup:
  - /include
  - /share/doc
  - /share/hdf5_examples
  - /share/man
  - /share/sip
  - '*.la'
  - '*.a'

modules:
  - name: python-numpy
    buildsystem: simple
    build-commands:
      - rm pyproject.toml
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/f6/d8/ab692a75f584d13c6542c3994f75def5bce52ded9399f52e230fe402819d/numpy-1.22.4.zip
        sha256: 425b390e4619f58d8526b3dcf656dde069133ae5c240229821f01b5f44ea07af
        x-checker-data:
          type: pypi
          name: numpy

  - name: python-pkgconfig
    buildsystem: simple
    ensure-writable:
      - /lib/python3.8/site-packages/easy-install.pth
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/c4/e0/e05fee8b5425db6f83237128742e7e5ef26219b687ab8f0d41ed0422125e/pkgconfig-1.5.5.tar.gz
        sha256: deb4163ef11f75b520d822d9505c1f462761b4309b1bb713d08689759ea8b899
        x-checker-data:
          type: pypi
          name: pkgconfig

  - name: python3-packaging
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/df/9e/d1a7217f69310c1db8fdf8ab396229f55a699ce34a203691794c5d1cad0c/packaging-21.3.tar.gz
        sha256: dd47c42927d89ab911e606518907cc2d3a1f38bbd026385970643f9c5b8ecfeb
        x-checker-data:
          type: pypi
          name: packaging

  - name: python3-Pyparsing
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/71/22/207523d16464c40a0310d2d4d8926daffa00ac1f5b1576170a32db749636/pyparsing-3.0.9.tar.gz
        sha256: 2b020ecf7d21b687f219b71ecad3631f644a47f01403fa1d1036b0c6416d70fb
        x-checker-data:
          type: pypi
          name: Pyparsing

  - name: python3-toml
    buildsystem: simple
    ensure-writable:
      - /lib/python3.8/site-packages/easy-install.pth
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/be/ba/1f744cdc819428fc6b5084ec34d9b30660f6f9daaf70eead706e3203ec3c/toml-0.10.2.tar.gz
        sha256: b3bda1d108d5dd99f4a20d24d9c348e91c4db7ab1b749200bded2f839ccbe68f
        x-checker-data:
          type: pypi
          name: toml

  - name: hdf5
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DBUILD_TESTING:BOOL=OFF
      - -DHDF5_BUILD_EXAMPLES:BOOL=OFF
    cleanup:
      - /share/hdf5_examples
    sources:
      - type: archive
        url: https://github.com/HDFGroup/hdf5/archive/refs/tags/hdf5-1_13_1.tar.gz
        sha256: 92552458f35c7e58128ce1bfc2831abf901cc142ea0fdd2b056311e4452db7bf
        x-checker-data:
          type: anitya
          project-id: 1303
          stable-only: true
          url-template: https://github.com/HDFGroup/hdf5/archive/refs/tags/hdf5-$version.tar.gz

  - name: python-h5py
    buildsystem: simple
    ensure-writable:
      - /lib/python3.8/site-packages/easy-install.pth
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/c5/40/7cf58e6230f0e76699f011c6d293dd47755997709a303a4e644823f3a753/h5py-3.7.0.tar.gz
        sha256: 3fcf37884383c5da64846ab510190720027dca0768def34dd8dcb659dbe5cbf3
        x-checker-data:
          type: pypi
          name: h5py

  - name: ghostscript
    config-opts:
      - --enable-dynamic
      - --disable-cups
      - --disable-dbus
      - --disable-gtk
      - --with-drivers=FILES
# https://github.com/flathub/flathub/pull/825#issuecomment-457206134
# https://flathub.org/builds/#/builders/36/builds/687
# https://github.com/imagemin/optipng-bin/issues/97#issue-317622868
# https://discourse.libsdl.org/t/ndk-sdl2-image-libpng-build-error-png-init-filter-functions-neon/24947/3
    build-options:
      arch:
        aarch64:
          cppflags: -DPNG_ARM_NEON_OPT=0
    sources:
      - type: archive
        url: https://github.com/ArtifexSoftware/ghostpdl-downloads/releases/download/gs9540/ghostscript-9.54.0.tar.gz
        sha256: 0646bb97f6f4d10a763f4919c54fa28b4fbdd3dff8e7de3410431c81762cade0
        x-checker-data:
          type: anitya
          project-id: 1157
          stable-only: true
          url-template: https://github.com/ArtifexSoftware/ghostpdl-downloads/releases/download/gs9540/ghostscript-$version.tar.gz
    cleanup:
      - /share/doc

  - name: python-astropy
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/67/3d/bf8dd07f37dd9d1b14bc92985734a3eb7fb15a136dba1ebcc3e3a76d9327/astropy-5.1.tar.gz
        sha256: 1db1b2c7eddfc773ca66fa33bd07b25d5b9c3b5eee2b934e0ca277fa5b1b7b7e
        x-checker-data:
          type: pypi
          name: astropy
    modules:
      - name: python-setuptools-scm
        buildsystem: simple
        build-commands:
          - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
        sources:
          - type: archive
            url: https://files.pythonhosted.org/packages/43/70/aff5e3c2463b08997e21f5f961d6ebfd32ce56d6026394664d6a10090cbb/setuptools_scm-7.0.2.tar.gz
            sha256: 53afbaa882f43e5ec8e14f2d93b9c268dc62eb3f6cc8b2790f8cb97903e53c02
            x-checker-data:
              type: pypi
              name: setuptools-scm
      - name: python-flit-core
        buildsystem: simple
        build-commands:
          - pip3 install . --prefix=/app --no-index --find-links .
        sources:
          - type: archive
            url: https://files.pythonhosted.org/packages/6f/cd/3653de7b1d61f0ef95f2459ac752f23a91dbc84f991787201aa52d0cf1cc/flit_core-3.3.0.tar.gz
            sha256: b1404accffd6504b5f24eeca9ec5d3c877f828d16825348ba81515fa084bd5f0
      - python3-tomli.json
      - name: python-flit-core-new
        buildsystem: simple
        build-commands:
          - pip3 install . --prefix=/app --no-index --find-links .
        sources:
          - type: archive
            url: https://files.pythonhosted.org/packages/15/d1/d8798b83e953fd6f86ca9b50f93eec464a9305b0661469c8234e61095481/flit_core-3.7.1.tar.gz
            sha256: 14955af340c43035dbfa96b5ee47407e377ee337f69e70f73064940d27d0a44f
            x-checker-data:
              type: pypi
              name: flit-core
      - name: python-extension-helpers
        buildsystem: simple
        build-commands:
          - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
        sources:
          - type: archive
            url: https://files.pythonhosted.org/packages/15/44/fc7754aa170b1f3b4318b009d00f1045a7f4616e2b77bcc3b3d4f5601be5/extension-helpers-1.0.0.tar.gz
            sha256: ca1bfac67c79cf4a7a0c09286ce2a24eec31bf17715818d0726318dd0e5050e6
            x-checker-data:
              type: pypi
              name: extension-helpers
      - name: python-jinja2
        buildsystem: simple
        build-commands:
          - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
        sources:
          - type: archive
            url: https://files.pythonhosted.org/packages/7a/ff/75c28576a1d900e87eb6335b063fab47a8ef3c8b4d88524c4bf78f670cce/Jinja2-3.1.2.tar.gz
            sha256: 31351a702a408a9e7595a8fc6150fc3f43bb6bf7e319770cbc0db9df9437e852
            x-checker-data:
              type: pypi
              name: jinja2
      - name: python-MarkupSafe
        buildsystem: simple
        build-commands:
          - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
        sources:
          - type: archive
            url: https://files.pythonhosted.org/packages/1d/97/2288fe498044284f39ab8950703e88abbac2abbdf65524d576157af70556/MarkupSafe-2.1.1.tar.gz
            sha256: 7f91197cc9e48f989d12e4e6fbc46495c446636dfc81b9ccf50bb0ec74b91d4b
            x-checker-data:
              type: pypi
              name: MarkupSafe
      - name: python-pyerfa
        buildsystem: simple
        build-commands:
          - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
        sources:
          - type: archive
            url: https://files.pythonhosted.org/packages/78/fd/0148f0e54f0c6f48a141409df65d74a5f1dae2e139f23d50a43c58c16098/pyerfa-2.0.0.1.tar.gz
            sha256: 2fd4637ffe2c1e6ede7482c13f583ba7c73119d78bef90175448ce506a0ede30
            x-checker-data:
              type: pypi
              name: pyerfa

  - name: python-pyemf
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: git
        url: https://github.com/jeremysanders/pyemf
        tag: master
        commit: 830e61008af8acf1830e5c91dc876313a771afdb

  - name: python-dbus-python
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/b1/5c/ccfc167485806c1936f7d3ba97db6c448d0089c5746ba105b6eb22dba60e/dbus-python-1.2.18.tar.gz
        sha256: 92bdd1e68b45596c833307a5ff4b217ee6929a1502f5341bae28fd120acf7260
        x-checker-data:
          type: pypi
          name: dbus-python

  - name: python-iminuit
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/08/c1/7babeefdb5a376e20fc39b6cdc9b35f89eb7ae5343ca9a51a2c577afca33/iminuit-2.12.0.tar.gz
        sha256: cd0e3cb751302c066984eab30612c5d2419a54317febe51b50be1fa21afc51a9
        x-checker-data:
          type: pypi
          name: iminuit
        # Fix pybind11 cannot find python3 from u/tinywrkb
      - type: patch
        path: pybind11_include_dirs.patch

    # Use PyQt5 from org.qutebrowser.qutebrowser with QtSvg enabled
  - pyqt5/pyqt5.json

  - name: Veusz
    buildsystem: simple
    build-options:
      env:
        LIBRARY_PATH: /app/lib:/usr/lib
        LD_LIBRARY_PATH: /app/lib:/usr/lib
        LD_PRELOAD_PATH: /app/lib:/usr/lib
    ensure-writable:
      - /lib/python3.8/site-packages/easy-install.pth
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
      - install -Dm644 icons/veusz_128.png ${FLATPAK_DEST}/share/icons/hicolor/128x128/apps/${FLATPAK_ID}.png
      - install -Dm644 icons/veusz.svg ${FLATPAK_DEST}/share/icons/hicolor/scalable/apps/${FLATPAK_ID}.svg
      - install -Dm644 support/veusz.appdata.xml ${FLATPAK_DEST}/share/appdata/${FLATPAK_ID}.appdata.xml
      - install -Dm644 support/veusz.desktop ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop
      - desktop-file-edit --set-key=Icon --set-value=${FLATPAK_ID} ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop
    sources:
      - type: git
        url: https://github.com/veusz/veusz
        tag: veusz-3.4
        commit: 6fac396be3c9f19610fa433705decfa05dfdad49
        x-checker-data:
          type: git
          tag-pattern: ^(veusz-[\d.]+)$
      - type: patch
        path: change-pyqt-dir.patch
      - type: patch
        path: fix-appdata.patch
