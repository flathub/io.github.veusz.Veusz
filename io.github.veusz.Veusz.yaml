app-id: io.github.veusz.Veusz
runtime: org.kde.Platform
runtime-version: 5.15-22.08
sdk: org.kde.Sdk
base: com.riverbankcomputing.PyQt.BaseApp
base-version: 5.15-22.08
command: veusz
separate-locales: false

finish-args:
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  - --device=dri

cleanup:
  - /include
  - /share/doc
  - /share/man
  - /share/sip
  - '*.la'
  - '*.a'
  - /bin/f*   # clean everything except gs+veusz
  - /bin/samp_hub
  - /bin/showtable
  - /bin/*lint

cleanup-commands:
  - /app/cleanup-BaseApp.sh

build-options:
  env:
    - BASEAPP_REMOVE_WEBENGINE=1

modules:
  - name: python3-numpy
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=/app --root=/
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/a0/41/8f53eff8e969dd8576ddfb45e7ed315407d27c7518ae49418be8ed532b07/numpy-1.25.2.tar.gz
        sha256: fd608e19c8d7c55021dffd43bfe5492fab8cc105cc8986f813f8c3c048b38760
        x-checker-data:
          type: pypi
          name: numpy

  - name: hdf5
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DBUILD_TESTING:BOOL=OFF
      - -DHDF5_BUILD_EXAMPLES:BOOL=OFF
    cleanup:
      - /share/hdf5_examples
      - /bin/*
    sources:
      - type: archive
        url: https://github.com/HDFGroup/hdf5/archive/refs/tags/hdf5-1_13_1.tar.gz
        sha256: 92552458f35c7e58128ce1bfc2831abf901cc142ea0fdd2b056311e4452db7bf
        # x-checker-data:
        #   type: anitya
        #   project-id: 1303
        #   stable-only: true
        #   url-template: https://github.com/HDFGroup/hdf5/archive/refs/tags/hdf5-$version.tar.gz

  - name: ghostscript
    config-opts:
      - --enable-dynamic
      - --disable-cups
      - --disable-dbus
      - --disable-gtk
      - --with-drivers=FILES
# https://github.com/flathub/flathub/pull/825#issuecomment-457206134
# https://flathub.org/builds/#/builders/36/builds/687
# https://github.com/imagemin/optipng-bin/issues/97#issue-317622868
# https://discourse.libsdl.org/t/ndk-sdl2-image-libpng-build-error-png-init-filter-functions-neon/24947/3
    build-options:
      arch:
        aarch64:
          cppflags: -DPNG_ARM_NEON_OPT=0
    sources:
      - type: archive
        url: https://github.com/ArtifexSoftware/ghostpdl-downloads/releases/download/gs10012/ghostscript-10.01.2.tar.gz
        sha256: a4cd61a07fec161bee35da0211a5e5cde8ff8a0aaf942fc0176715e499d21661
        x-checker-data:
          type: json
          url: https://api.github.com/repos/ArtifexSoftware/ghostpdl-downloads/releases/latest
          version-query: .name | sub("^Ghostscript/GhostPDL "; "")
          url-query: .assets[] | select(.name=="ghostscript-" + $version + ".tar.gz")
            | .browser_download_url
    cleanup:
      - /share/doc
      - /bin/???*   # everything in /bin except gs

  - name: python-pyemf3
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: git
        url: https://github.com/jeremysanders/pyemf3
        tag: v3.1
        commit: 185a621e5fc9054c27626da738f1f2fe63966b76

  # Cannot get to run currently
  # - name: python-dbus-python
  #   buildsystem: simple
  #   build-commands:
  #     - pip3 install --verbose --prefix=${FLATPAK_DEST} .
  #   sources:
  #     - type: archive
  #       url: https://files.pythonhosted.org/packages/c1/d3/6be85a9c772d6ebba0cc3ab37390dd6620006dcced758667e0217fb13307/dbus-python-1.3.2.tar.gz
  #       sha256: ad67819308618b5069537be237f8e68ca1c7fcc95ee4a121fe6845b1418248f8
  #       x-checker-data:
  #         type: pypi
  #         name: dbus-python

  # Python modules that work without modifications:
  # flatpak-pip-generator extension-helpers astropy pkgconfig h5py==3.7.0 tomli --checker-data
  - python3-modules.json

  - name: python3-iminuit
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/52/09/fa129a555e36ee059d63b841ac3542685330352261d890548283244f7f2a/iminuit-2.24.0.tar.gz
        sha256: 25ab631c3c8e024b1bcc7c96f66338caac54a4a2324d55f1e3ba5617816e44fd
        x-checker-data:
          type: pypi
          name: iminuit
      # Fix pybind11 cannot find python3 from u/tinywrkb
      - type: patch
        path: pybind11_include_dirs.patch

  - name: Veusz
    buildsystem: simple
    build-options:
      env:
        LIBRARY_PATH: /app/lib:/usr/lib
        LD_LIBRARY_PATH: /app/lib:/usr/lib
        LD_PRELOAD_PATH: /app/lib:/usr/lib
    ensure-writable:
      - /lib/python3.10/site-packages/easy-install.pth
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
      - install -Dm644 icons/veusz_128.png ${FLATPAK_DEST}/share/icons/hicolor/128x128/apps/${FLATPAK_ID}.png
      - install -Dm644 icons/veusz.svg ${FLATPAK_DEST}/share/icons/hicolor/scalable/apps/${FLATPAK_ID}.svg
      - install -Dm644 support/veusz.appdata.xml ${FLATPAK_DEST}/share/appdata/${FLATPAK_ID}.appdata.xml
      - install -Dm644 support/veusz.desktop ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop
      - desktop-file-edit --set-key=Icon --set-value=${FLATPAK_ID} ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop
    sources:
      - type: git
        url: https://github.com/veusz/veusz
        tag: veusz-3.6.2
        commit: c690eb61739312cd85ff9e2632357f410c10bc9f
        x-checker-data:
          type: git
          tag-pattern: ^(veusz-[\d.]+)$
      - type: patch
        path: change-pyqt-dir.patch
      - type: patch
        path: fix-appdata.patch
