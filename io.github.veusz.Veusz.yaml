app-id: io.github.veusz.Veusz
runtime: org.kde.Platform
runtime-version: '5.15'
sdk: org.kde.Sdk
command: veusz
separate-locales: false
finish-args:
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  - --device=dri

cleanup:
  - /include
  - /share/doc
  - /share/hdf5_examples
  - /share/man
  - /share/sip
  - '*.la'
  - '*.a'

modules:
  - name: python-numpy
    buildsystem: simple
    build-commands:
      - rm pyproject.toml
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/fb/48/b0708ebd7718a8933f0d3937513ef8ef2f4f04529f1f66ca86d873043921/numpy-1.21.4.zip
        sha256: e6c76a87633aa3fa16614b61ccedfae45b91df2767cf097aa9c933932a7ed1e0
        x-checker-data:
          type: pypi
          name: numpy

  - name: python-pkgconfig
    buildsystem: simple
    ensure-writable:
      - /lib/python3.8/site-packages/easy-install.pth
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/c4/e0/e05fee8b5425db6f83237128742e7e5ef26219b687ab8f0d41ed0422125e/pkgconfig-1.5.5.tar.gz
        sha256: deb4163ef11f75b520d822d9505c1f462761b4309b1bb713d08689759ea8b899
        x-checker-data:
          type: pypi
          name: pkgconfig

  - name: python3-packaging
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/df/9e/d1a7217f69310c1db8fdf8ab396229f55a699ce34a203691794c5d1cad0c/packaging-21.3.tar.gz
        sha256: dd47c42927d89ab911e606518907cc2d3a1f38bbd026385970643f9c5b8ecfeb
        x-checker-data:
          type: pypi
          name: packaging

  - name: python3-Pyparsing
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/ab/61/1a1613e3dcca483a7aa9d446cb4614e6425eb853b90db131c305bd9674cb/pyparsing-3.0.6.tar.gz
        sha256: d9bdec0013ef1eb5a84ab39a3b3868911598afa494f5faa038647101504e2b81
        x-checker-data:
          type: pypi
          name: Pyparsing

  - name: python3-toml
    buildsystem: simple
    ensure-writable:
      - /lib/python3.8/site-packages/easy-install.pth
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/be/ba/1f744cdc819428fc6b5084ec34d9b30660f6f9daaf70eead706e3203ec3c/toml-0.10.2.tar.gz
        sha256: b3bda1d108d5dd99f4a20d24d9c348e91c4db7ab1b749200bded2f839ccbe68f
        x-checker-data:
          type: pypi
          name: toml

  - name: hdf5
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DBUILD_TESTING:BOOL=OFF
      - -DHDF5_BUILD_EXAMPLES:BOOL=OFF
    cleanup:
      - /share/hdf5_examples
    sources:
      - type: archive
        url: https://github.com/HDFGroup/hdf5/archive/refs/tags/hdf5-1_12_1.tar.gz
        sha256: e6dde173c2d243551922d23a0387a79961205b018502e6a742acb30b61bc2d5f
        x-checker-data:
          type: anitya
          project-id: 1303
          stable-only: true
          url-template: https://github.com/HDFGroup/hdf5/archive/refs/tags/hdf5-$version.tar.gz

  - name: python-h5py
    buildsystem: simple
    ensure-writable:
      - /lib/python3.8/site-packages/easy-install.pth
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/0a/39/62ec4c1cc96408f6cf27c1d10a26409b98eb6aa2dda7d9c48d204c09b970/h5py-3.6.0.tar.gz
        sha256: 8752d2814a92aba4e2b2a5922d2782d0029102d99caaf3c201a566bc0b40db29
        x-checker-data:
          type: pypi
          name: h5py
      - type: patch
        path: python-h5py-relax-dependency-versions.patch

  - name: ghostscript
    config-opts:
      - --enable-dynamic
      - --disable-cups
      - --disable-dbus
      - --disable-gtk
      - --with-drivers=FILES
# https://github.com/flathub/flathub/pull/825#issuecomment-457206134
# https://flathub.org/builds/#/builders/36/builds/687
# https://github.com/imagemin/optipng-bin/issues/97#issue-317622868
# https://discourse.libsdl.org/t/ndk-sdl2-image-libpng-build-error-png-init-filter-functions-neon/24947/3
    build-options:
      arch:
        aarch64:
          cppflags: -DPNG_ARM_NEON_OPT=0
    sources:
      - type: archive
        url: https://github.com/ArtifexSoftware/ghostpdl-downloads/releases/download/gs9540/ghostscript-9.54.0.tar.gz
        sha256: 0646bb97f6f4d10a763f4919c54fa28b4fbdd3dff8e7de3410431c81762cade0
        x-checker-data:
          type: anitya
          project-id: 1157
          stable-only: true
          url-template: https://github.com/ArtifexSoftware/ghostpdl-downloads/releases/download/gs9540/ghostscript-$version.tar.gz
    cleanup:
      - /share/doc

  - name: python-astropy
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/10/d4/64a538ec598035dc3131953bf891cf1df9757dfbd084ab49dc51aae7d53f/astropy-4.3.1.tar.gz
        sha256: 2d3951223b4eb7f368fcad8c8340d27374c5d8e3b635a636275acdb38f35cd51
        x-checker-data:
          type: pypi
          name: astropy
    modules:
      - name: python-setuptools-scm
        buildsystem: simple
        build-commands:
          - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
        sources:
          - type: archive
            url: https://files.pythonhosted.org/packages/4b/0d/ecb9595fae02467edba5023eb8a23c688d2b438a6a8d1a9e2b8649faf23d/setuptools_scm-6.3.2.tar.gz
            sha256: a49aa8081eeb3514eb9728fa5040f2eaa962d6c6f4ec9c32f6c1fba88f88a0f2
            x-checker-data:
              type: pypi
              name: setuptools-scm
      - name: python-flit-core
        buildsystem: simple
        build-commands:
          - pip3 install . --prefix=/app --no-index --find-links .
        sources:
          - type: archive
            url: https://files.pythonhosted.org/packages/6f/cd/3653de7b1d61f0ef95f2459ac752f23a91dbc84f991787201aa52d0cf1cc/flit_core-3.3.0.tar.gz
            sha256: b1404accffd6504b5f24eeca9ec5d3c877f828d16825348ba81515fa084bd5f0
      - python3-tomli.json
      - name: python-flit-core-new
        buildsystem: simple
        build-commands:
          - pip3 install . --prefix=/app --no-index --find-links .
        sources:
          - type: archive
            url: https://files.pythonhosted.org/packages/2c/a9/64406cf5c1c31186e1208a290ff10a0add43882edaef5eeba49e15ba6e7f/flit_core-3.4.0.tar.gz
            sha256: 29468fa2330969167d1f5c23eb9c0661cb6dacfcd46f361a274609a7f4197530
            x-checker-data:
              type: pypi
              name: flit-core
      - name: python-extension-helpers
        buildsystem: simple
        build-commands:
          - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
        sources:
          - type: archive
            url: https://files.pythonhosted.org/packages/81/78/056daee475dfc41cc0b62540388703cddcae4d4f6bef10c6ce1aea76ebaf/extension-helpers-0.1.tar.gz
            sha256: ac8a6fe91c6d98986a51a9f08ca0c7945f8fd70d95b662ced4040ae5eb973882
            x-checker-data:
              type: pypi
              name: extension-helpers
      - name: python-jinja2
        buildsystem: simple
        build-commands:
          - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
        sources:
          - type: archive
            url: https://files.pythonhosted.org/packages/91/a5/429efc6246119e1e3fbf562c00187d04e83e54619249eb732bb423efa6c6/Jinja2-3.0.3.tar.gz
            sha256: 611bb273cd68f3b993fabdc4064fc858c5b47a973cb5aa7999ec1ba405c87cd7
            x-checker-data:
              type: pypi
              name: jinja2
      - name: python-MarkupSafe
        buildsystem: simple
        build-commands:
          - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
        sources:
          - type: archive
            url: https://files.pythonhosted.org/packages/bf/10/ff66fea6d1788c458663a84d88787bae15d45daa16f6b3ef33322a51fc7e/MarkupSafe-2.0.1.tar.gz
            sha256: 594c67807fb16238b30c44bdf74f36c02cdf22d1c8cda91ef8a0ed8dabf5620a
            x-checker-data:
              type: pypi
              name: MarkupSafe
      - name: python-pyerfa
        buildsystem: simple
        build-commands:
          - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
        sources:
          - type: archive
            url: https://files.pythonhosted.org/packages/78/fd/0148f0e54f0c6f48a141409df65d74a5f1dae2e139f23d50a43c58c16098/pyerfa-2.0.0.1.tar.gz
            sha256: 2fd4637ffe2c1e6ede7482c13f583ba7c73119d78bef90175448ce506a0ede30
            x-checker-data:
              type: pypi
              name: pyerfa

  - name: python-pyemf
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: git
        url: https://github.com/jeremysanders/pyemf
        tag: master
        commit: 830e61008af8acf1830e5c91dc876313a771afdb

  - name: python-dbus-python
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/b1/5c/ccfc167485806c1936f7d3ba97db6c448d0089c5746ba105b6eb22dba60e/dbus-python-1.2.18.tar.gz
        sha256: 92bdd1e68b45596c833307a5ff4b217ee6929a1502f5341bae28fd120acf7260
        x-checker-data:
          type: pypi
          name: dbus-python

  - name: python-iminuit
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/02/93/03a5b0c66b17027400a0e596fec5928e6b895eaf8c46902878ceaecd7902/iminuit-2.8.4.tar.gz
        sha256: 4b09189f3094896cfc68596adc95b7f1d92772e1de1424e5dc4dd81def56e8b0
        x-checker-data:
          type: pypi
          name: iminuit
        # Fix pybind11 cannot find python3 from u/tinywrkb
      - type: patch
        path: pybind11_include_dirs.patch

  - pyqt5/pyqt5.json

  - name: Veusz
    buildsystem: simple
    build-options:
      env:
        LIBRARY_PATH: /app/lib:/usr/lib
        LD_LIBRARY_PATH: /app/lib:/usr/lib
        LD_PRELOAD_PATH: /app/lib:/usr/lib
    ensure-writable:
      - /lib/python3.8/site-packages/easy-install.pth
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
      - install -Dm644 icons/veusz_128.png ${FLATPAK_DEST}/share/icons/hicolor/128x128/apps/${FLATPAK_ID}.png
      - install -Dm644 icons/veusz.svg ${FLATPAK_DEST}/share/icons/hicolor/scalable/apps/${FLATPAK_ID}.svg
      - install -Dm644 support/veusz.appdata.xml ${FLATPAK_DEST}/share/appdata/${FLATPAK_ID}.appdata.xml
      - install -Dm644 support/veusz.desktop ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop
      - desktop-file-edit --set-key=Icon --set-value=${FLATPAK_ID} ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop
    sources:
      - type: git
        url: https://github.com/veusz/veusz
        tag: veusz-3.4
        commit: 6fac396be3c9f19610fa433705decfa05dfdad49
        x-checker-data:
          type: git
          tag-pattern: ^(veusz-[\d.]+)$
      - type: patch
        path: change-pyqt-dir.patch
      - type: patch
        path: fix-appdata.patch
