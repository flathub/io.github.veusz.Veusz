app-id: io.github.veusz.Veusz
runtime: org.kde.Platform
runtime-version: 5.15-21.08
sdk: org.kde.Sdk
base: com.riverbankcomputing.PyQt.BaseApp
base-version: 5.15-21.08
command: veusz
separate-locales: false

finish-args:
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  - --device=dri

cleanup:
  - /include
  - /share/doc
  - /share/man
  - /share/sip
  - '*.la'
  - '*.a'
  - /bin/f*   # clean everything except gs+veusz
  - /bin/samp_hub
  - /bin/showtable
  - /bin/*lint

cleanup-commands:
  - /app/cleanup-BaseApp.sh

build-options:
  env:
    - BASEAPP_REMOVE_WEBENGINE=1

modules:
  - name: hdf5
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DBUILD_TESTING:BOOL=OFF
      - -DHDF5_BUILD_EXAMPLES:BOOL=OFF
    cleanup:
      - /share/hdf5_examples
      - /bin/*
    sources:
      - type: archive
        url: https://github.com/HDFGroup/hdf5/archive/refs/tags/hdf5-1_13_3.tar.gz
        sha256: a59d046486c9e2076a33b5b389479a2476cfe496601dffd36bd354755630d22c
        x-checker-data:
          type: anitya
          project-id: 1303
          stable-only: true
          url-template: https://github.com/HDFGroup/hdf5/archive/refs/tags/hdf5-$version.tar.gz

  - name: ghostscript
    config-opts:
      - --enable-dynamic
      - --disable-cups
      - --disable-dbus
      - --disable-gtk
      - --with-drivers=FILES
# https://github.com/flathub/flathub/pull/825#issuecomment-457206134
# https://flathub.org/builds/#/builders/36/builds/687
# https://github.com/imagemin/optipng-bin/issues/97#issue-317622868
# https://discourse.libsdl.org/t/ndk-sdl2-image-libpng-build-error-png-init-filter-functions-neon/24947/3
    build-options:
      arch:
        aarch64:
          cppflags: -DPNG_ARM_NEON_OPT=0
    sources:
      - type: archive
        url: https://github.com/ArtifexSoftware/ghostpdl-downloads/releases/download/gs1000/ghostscript-10.0.0.tar.gz
        sha256: a57764d70caf85e2fc0b0f59b83b92e25775631714dcdb97cc6e0cea414bb5a3
        x-checker-data:
          type: json
          url: https://api.github.com/repos/ArtifexSoftware/ghostpdl-downloads/releases/latest
          version-query: .name | sub("^Ghostscript/GhostPDL "; "")
          url-query: .assets[] | select(.name=="ghostscript-" + $version + ".tar.gz")
            | .browser_download_url
    cleanup:
      - /share/doc
      - /bin/???*   # everything in /bin except gs

  - name: python-pyemf3
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: git
        url: https://github.com/jeremysanders/pyemf3
        tag: v3.1
        commit: 185a621e5fc9054c27626da738f1f2fe63966b76

  # Cannot get to run currently
  # - name: python-dbus-python
  #   buildsystem: simple
  #   build-commands:
  #     - pip3 install --verbose --prefix=${FLATPAK_DEST} .
  #   sources:
  #     - type: archive
  #       url: https://files.pythonhosted.org/packages/c1/d3/6be85a9c772d6ebba0cc3ab37390dd6620006dcced758667e0217fb13307/dbus-python-1.3.2.tar.gz
  #       sha256: ad67819308618b5069537be237f8e68ca1c7fcc95ee4a121fe6845b1418248f8
  #       x-checker-data:
  #         type: pypi
  #         name: dbus-python

  # Python modules that work without modifications:
  # flatpak-pip-generator extension-helpers numpy astropy pkgconfig h5py tomli --checker-data
  - python3-modules.json

  - name: python3-iminuit
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/28/14/6bf592c1e821b4c560f3a19905cd12182562778a767cea6755002c3d26d0/iminuit-2.18.0.tar.gz
        sha256: 7ee2c6a0bcdac581b38fae8d0f343fdee55f91f1f6a6cc9643fcfbcc6c2dc3e6
        x-checker-data:
          type: pypi
          name: iminuit
      # Fix pybind11 cannot find python3 from u/tinywrkb
      - type: patch
        path: pybind11_include_dirs.patch

  - name: Veusz
    buildsystem: simple
    build-options:
      env:
        LIBRARY_PATH: /app/lib:/usr/lib
        LD_LIBRARY_PATH: /app/lib:/usr/lib
        LD_PRELOAD_PATH: /app/lib:/usr/lib
    ensure-writable:
      - /lib/python3.8/site-packages/easy-install.pth
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
      - install -Dm644 icons/veusz_128.png ${FLATPAK_DEST}/share/icons/hicolor/128x128/apps/${FLATPAK_ID}.png
      - install -Dm644 icons/veusz.svg ${FLATPAK_DEST}/share/icons/hicolor/scalable/apps/${FLATPAK_ID}.svg
      - install -Dm644 support/veusz.appdata.xml ${FLATPAK_DEST}/share/appdata/${FLATPAK_ID}.appdata.xml
      - install -Dm644 support/veusz.desktop ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop
      - desktop-file-edit --set-key=Icon --set-value=${FLATPAK_ID} ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop
    sources:
      - type: git
        url: https://github.com/veusz/veusz
        tag: veusz-3.5.3
        commit: c9a61d1d03b7d81aad18a4a1ad64916dea1df90f
        x-checker-data:
          type: git
          tag-pattern: ^(veusz-[\d.]+)$
      - type: patch
        path: change-pyqt-dir.patch
      - type: patch
        path: fix-appdata.patch
