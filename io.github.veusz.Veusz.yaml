app-id: io.github.veusz.Veusz
runtime: org.kde.Sdk
runtime-version: 5.15-21.08
sdk: org.kde.Sdk
base: com.riverbankcomputing.PyQt.BaseApp
base-version: 5.15-21.08
command: veusz
separate-locales: false
#cleanup-commands:
  #- /app/cleanup-BaseApp.sh
#build-options:
  #env:
    #- BASEAPP_REMOVE_WEBENGINE=1
finish-args:
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  - --device=dri
cleanup:
  - /include
  - /share/doc
  - /share/hdf5_examples
  - /share/man
  - /share/sip
  - '*.la'
  - '*.a'

modules:
  - name: python-numpy
    buildsystem: simple
    build-commands:
      - rm pyproject.toml
      - pip3 install --exists-action=i --no-index --no-deps --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} .
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/64/4a/b008d1f8a7b9f5206ecf70a53f84e654707e7616a771d84c05151a4713e9/numpy-1.22.3.zip
        sha256: dbc7601a3b7472d559dc7b933b18b4b66f9aa7452c120e87dfb33d02008c8a18
        x-checker-data:
          type: pypi
          name: numpy

  - name: python-pkgconfig
    buildsystem: simple
    ensure-writable:
      - /lib/python3.9/site-packages/easy-install.pth
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/c4/e0/e05fee8b5425db6f83237128742e7e5ef26219b687ab8f0d41ed0422125e/pkgconfig-1.5.5.tar.gz
        sha256: deb4163ef11f75b520d822d9505c1f462761b4309b1bb713d08689759ea8b899
        x-checker-data:
          type: pypi
          name: pkgconfig

  #- name: python3-Pyparsing
    #buildsystem: simple
    #build-commands:
      #- python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    #sources:
      #- type: archive
        #url: https://files.pythonhosted.org/packages/31/df/789bd0556e65cf931a5b87b603fcf02f79ff04d5379f3063588faaf9c1e4/pyparsing-3.0.8.tar.gz
        #sha256: 7bf433498c016c4314268d95df76c81b842a4cb2b276fa3312cfb1e1d85f6954
        #x-checker-data:
          #type: pypi
          #name: Pyparsing

  - name: hdf5
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DBUILD_TESTING:BOOL=OFF
      - -DHDF5_BUILD_EXAMPLES:BOOL=OFF
    cleanup:
      - /share/hdf5_examples
    sources:
      - type: archive
        url: https://github.com/HDFGroup/hdf5/archive/refs/tags/hdf5-1_13_1.tar.gz
        sha256: 92552458f35c7e58128ce1bfc2831abf901cc142ea0fdd2b056311e4452db7bf
        x-checker-data:
          type: anitya
          project-id: 1303
          stable-only: true
          url-template: https://github.com/HDFGroup/hdf5/archive/refs/tags/hdf5-$version.tar.gz

  - name: python-h5py
    buildsystem: simple
    ensure-writable:
      - /lib/python/site-packages/easy-install.pth
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/0a/39/62ec4c1cc96408f6cf27c1d10a26409b98eb6aa2dda7d9c48d204c09b970/h5py-3.6.0.tar.gz
        sha256: 8752d2814a92aba4e2b2a5922d2782d0029102d99caaf3c201a566bc0b40db29
        x-checker-data:
          type: pypi
          name: h5py

  - name: ghostscript
    config-opts:
      - --enable-dynamic
      - --disable-cups
      - --disable-dbus
      - --disable-gtk
      - --with-drivers=FILES
# https://github.com/flathub/flathub/pull/825#issuecomment-457206134
# https://flathub.org/builds/#/builders/36/builds/687
# https://github.com/imagemin/optipng-bin/issues/97#issue-317622868
# https://discourse.libsdl.org/t/ndk-sdl2-image-libpng-build-error-png-init-filter-functions-neon/24947/3
    build-options:
      arch:
        aarch64:
          cppflags: -DPNG_ARM_NEON_OPT=0
    sources:
      - type: archive
        url: https://github.com/ArtifexSoftware/ghostpdl-downloads/releases/download/gs9540/ghostscript-9.54.0.tar.gz
        sha256: 0646bb97f6f4d10a763f4919c54fa28b4fbdd3dff8e7de3410431c81762cade0
        x-checker-data:
          type: anitya
          project-id: 1157
          stable-only: true
          url-template: https://github.com/ArtifexSoftware/ghostpdl-downloads/releases/download/gs9540/ghostscript-$version.tar.gz
    cleanup:
      - /share/doc

  - name: python-astropy
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/a3/d6/b36be0232fa0761f4f3484eb5907224feebf0b359fde2218b01e782649c6/astropy-5.0.4.tar.gz
        sha256: 001184f1a9c3f526a363883ce28efb9cbf076df3d151ca3e131509a248f0dfb9
        x-checker-data:
          type: pypi
          name: astropy
    modules:
      - name: python-extension-helpers
        buildsystem: simple
        build-commands:
          - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
        sources:
          - type: archive
            url: https://files.pythonhosted.org/packages/81/78/056daee475dfc41cc0b62540388703cddcae4d4f6bef10c6ce1aea76ebaf/extension-helpers-0.1.tar.gz
            sha256: ac8a6fe91c6d98986a51a9f08ca0c7945f8fd70d95b662ced4040ae5eb973882
            x-checker-data:
              type: pypi
              name: extension-helpers
      - name: python-jinja2
        buildsystem: simple
        build-commands:
          - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
        sources:
          - type: archive
            url: https://files.pythonhosted.org/packages/7a/ff/75c28576a1d900e87eb6335b063fab47a8ef3c8b4d88524c4bf78f670cce/Jinja2-3.1.2.tar.gz
            sha256: 31351a702a408a9e7595a8fc6150fc3f43bb6bf7e319770cbc0db9df9437e852
            x-checker-data:
              type: pypi
              name: jinja2
      - name: python-MarkupSafe
        buildsystem: simple
        build-commands:
          - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
        sources:
          - type: archive
            url: https://files.pythonhosted.org/packages/1d/97/2288fe498044284f39ab8950703e88abbac2abbdf65524d576157af70556/MarkupSafe-2.1.1.tar.gz
            sha256: 7f91197cc9e48f989d12e4e6fbc46495c446636dfc81b9ccf50bb0ec74b91d4b
            x-checker-data:
              type: pypi
              name: MarkupSafe
      - name: python-pyerfa
        buildsystem: simple
        build-commands:
          - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
        sources:
          - type: archive
            url: https://files.pythonhosted.org/packages/78/fd/0148f0e54f0c6f48a141409df65d74a5f1dae2e139f23d50a43c58c16098/pyerfa-2.0.0.1.tar.gz
            sha256: 2fd4637ffe2c1e6ede7482c13f583ba7c73119d78bef90175448ce506a0ede30
            x-checker-data:
              type: pypi
              name: pyerfa

  - name: python-pyemf
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: git
        url: https://github.com/jeremysanders/pyemf
        tag: master
        commit: 830e61008af8acf1830e5c91dc876313a771afdb

  - name: python-dbus-python
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/b1/5c/ccfc167485806c1936f7d3ba97db6c448d0089c5746ba105b6eb22dba60e/dbus-python-1.2.18.tar.gz
        sha256: 92bdd1e68b45596c833307a5ff4b217ee6929a1502f5341bae28fd120acf7260
        x-checker-data:
          type: pypi
          name: dbus-python

  - name: python-iminuit
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/f5/76/800d75e82805d06bfca3c29081eab195afb89c7f71d682ebb4186b821cba/iminuit-2.11.2.tar.gz
        sha256: 8cae7917ca2d22c691e00792bfbbb812b84ac5c75120eb2ae879fb4ada41ee6c
        x-checker-data:
          type: pypi
          name: iminuit
        # Fix pybind11 cannot find python3 from u/tinywrkb
      - type: patch
        path: pybind11_include_dirs.patch

  - name: python-parse
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/89/a1/82ce536be577ba09d4dcee45db58423a180873ad38a2d014d26ab7b7cb8a/parse-1.19.0.tar.gz
        sha256: 9ff82852bcb65d139813e2a5197627a94966245c897796760a3a2a8eb66f020b
        x-checker-data:
          type: pypi
          name: parse

  - name: Veusz
    buildsystem: simple
    build-options:
      env:
        LIBRARY_PATH: /app/lib:/usr/lib
        LD_LIBRARY_PATH: /app/lib:/usr/lib
        LD_PRELOAD_PATH: /app/lib:/usr/lib
    ensure-writable:
      - /lib/python3.9/site-packages/easy-install.pth
    build-commands:
      - pip3 install --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} .
      - install -Dm644 icons/veusz_128.png ${FLATPAK_DEST}/share/icons/hicolor/128x128/apps/${FLATPAK_ID}.png
      - install -Dm644 icons/veusz.svg ${FLATPAK_DEST}/share/icons/hicolor/scalable/apps/${FLATPAK_ID}.svg
      - install -Dm644 support/veusz.appdata.xml ${FLATPAK_DEST}/share/appdata/${FLATPAK_ID}.appdata.xml
      - install -Dm644 support/veusz.desktop ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop
      - desktop-file-edit --set-key=Icon --set-value=${FLATPAK_ID} ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop
    sources:
      - type: git
        url: https://github.com/veusz/veusz
        tag: veusz-3.4
        commit: 6fac396be3c9f19610fa433705decfa05dfdad49
        x-checker-data:
          type: git
          tag-pattern: ^(veusz-[\d.]+)$
      #- type: patch
        #path: change-pyqt-dir.patch
      #- type: patch
        #path: fix-appdata.patch
